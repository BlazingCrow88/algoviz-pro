{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="results-container">
    <div class="analytics-header">
        <h1>Code Analysis Results</h1>
        {# Action buttons at the top right so users can quickly start a new analysis or go back.
           Positioned these in the header instead of at the bottom because that's where users
           naturally look for navigation - learned that from UI/UX class #}
        <div class="analytics-header-actions">
            <a href="{% url 'analytics:analyze' %}" class="btn btn-primary">üìù Analyze New Code</a>
            <a href="{% url 'analytics:home' %}" class="btn btn-secondary">‚Üê Back</a>
        </div>
    </div>

    <!-- Overall Metrics -->
    {# Grid layout for metrics so users can see all the important stats at once without scrolling.
       Decided on 6 cards because it fills the screen nicely and covers the key quality indicators #}
    <div class="analytics-metrics-grid">
        {# Adding complexity_rating as a CSS class (low/moderate/high) so we can color-code the card.
           Makes it super obvious at a glance if code needs refactoring #}
        <div class="analytics-metric-card {{ complexity_rating.lower }}">
            <div class="analytics-metric-icon">üîÑ</div>
            <div class="analytics-metric-value">{{ analysis.cyclomatic_complexity }}</div>
            <div class="analytics-metric-label">Cyclomatic Complexity</div>
            <div class="analytics-metric-rating">{{ complexity_rating }}</div>
        </div>

        <div class="analytics-metric-card">
            <div class="analytics-metric-icon">üìä</div>
            {# Rounding maintainability index to whole number - decimals make it look more precise
               than it really is. This is a rough metric, not a scientific measurement #}
            <div class="analytics-metric-value">{{ analysis.maintainability_index|floatformat:0 }}</div>
            <div class="analytics-metric-label">Maintainability Index</div>
            <div class="analytics-metric-rating">{{ maintainability_rating }}</div>
        </div>

        <div class="analytics-metric-card">
            <div class="analytics-metric-icon">üìù</div>
            <div class="analytics-metric-value">{{ analysis.code_lines }}</div>
            <div class="analytics-metric-label">Lines of Code</div>
        </div>

        <div class="analytics-metric-card">
            <div class="analytics-metric-icon">üîß</div>
            <div class="analytics-metric-value">{{ analysis.num_functions }}</div>
            <div class="analytics-metric-label">Functions</div>
        </div>

        <div class="analytics-metric-card">
            <div class="analytics-metric-icon">üì¶</div>
            <div class="analytics-metric-value">{{ analysis.num_classes }}</div>
            <div class="analytics-metric-label">Classes</div>
        </div>

        {# Nesting depth gets special treatment with conditional coloring because deep nesting
           is a major code smell. Anything over 3 levels usually means you should refactor #}
        <div class="analytics-metric-card {% if analysis.max_nesting_depth > 3 %}high{% elif analysis.max_nesting_depth > 2 %}moderate{% else %}low{% endif %}">
            <div class="analytics-metric-icon">üîç</div>
            <div class="analytics-metric-value">{{ analysis.max_nesting_depth }}</div>
            <div class="analytics-metric-label">Max Nesting Depth</div>
            {# Extra warning badge for really high nesting - want to make sure users notice this #}
            {% if analysis.max_nesting_depth > 3 %}
            <div class="analytics-metric-warning">‚ö†Ô∏è High nesting</div>
            {% endif %}
        </div>
    </div>

    <!-- Recommendations -->
    {# Only show recommendations if there are any - keeps the page clean when code is already good #}
    {% if recommendations %}
    <div class="analytics-recommendations-section">
        <h2>üí° Recommendations</h2>
        <div class="analytics-recommendations-list">
            {% for recommendation in recommendations %}
            <div class="analytics-recommendation-card">
                {# Smart icon selection based on the recommendation text - makes it easier to spot
                   warnings vs. positive feedback. Used string matching because it's simpler than
                   passing icon types from the view #}
                <div class="analytics-recommendation-icon">
                    {% if 'high complexity' in recommendation.lower or 'nesting' in recommendation.lower %}
                        ‚ö†Ô∏è
                    {% elif 'good' in recommendation.lower or 'excellent' in recommendation.lower %}
                        ‚úÖ
                    {% else %}
                        üí°
                    {% endif %}
                </div>
                <div class="analytics-recommendation-text">{{ recommendation }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Function Metrics -->
    {# Function metrics table is the most detailed part - lets users drill down into which specific
       functions need work. This is way more useful than just overall stats #}
    {% if function_metrics %}
    <div class="analytics-functions-section">
        <h2>üîß Function Details</h2>
        <div class="analytics-functions-table">
            <table>
                <thead>
                    <tr>
                        <th>Function Name</th>
                        <th>Line #</th>
                        <th>Lines</th>
                        <th>Parameters</th>
                        <th>Complexity</th>
                        <th>Max Depth</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody>
                    {% for func in function_metrics %}
                    {# Color-coding table rows based on complexity - high complexity functions stand out
                       immediately. Makes it easy to prioritize which functions to refactor first #}
                    <tr class="{% if func.complexity > 10 %}high-complexity{% elif func.complexity > 5 %}medium-complexity{% endif %}">
                        <td class="analytics-func-name">{{ func.name }}</td>
                        <td>{{ func.line_number }}</td>
                        <td>{{ func.num_lines }}</td>
                        <td>{{ func.num_params }}</td>
                        <td class="analytics-complexity-cell">
                            {# Complexity gets its own badge with color coding - this is the most important
                               metric per function. Thresholds at 5 and 10 are industry standard #}
                            <span class="analytics-complexity-badge {% if func.complexity > 10 %}high{% elif func.complexity > 5 %}moderate{% else %}low{% endif %}">
                                {{ func.complexity }}
                            </span>
                        </td>
                        <td>{{ func.max_depth }}</td>
                        <td>
                            {# Visual ratings with emoji make it super clear at a glance - way better than
                               just showing numbers. Users can quickly scan for red X's and know what to fix #}
                            {% if func.complexity <= 5 %}
                                <span class="analytics-rating good">‚úÖ Good</span>
                            {% elif func.complexity <= 10 %}
                                <span class="analytics-rating moderate">‚ö†Ô∏è Moderate</span>
                            {% else %}
                                <span class="analytics-rating high">‚ùå High</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    {# Friendly message when there are no functions - better than showing an empty table #}
    <div class="analytics-no-functions">
        <p>‚ÑπÔ∏è No functions found in the analyzed code.</p>
    </div>
    {% endif %}

    <!-- Source Code Preview -->
    {# Including the actual source code at the bottom so users can reference what they analyzed.
       Especially helpful when looking at function metrics - can scroll down and see the actual code #}
    <div class="analytics-source-section">
        <h2>üìÑ Analyzed Code</h2>
        <div class="analytics-source-preview">
            <pre><code>{{ analysis.source_code }}</code></pre>
        </div>
    </div>
</div>

{# Analytics CSS loaded at the end for the same reason as other templates -
   lets it override base styles cleanly #}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
{% endblock %}