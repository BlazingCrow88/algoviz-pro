{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="viz-container">
    <h1>Algorithm Visualization</h1>

    <div class="controls-section">
        <div class="input-group">
            <label for="algorithm-select">Select Algorithm:</label>
            <select id="algorithm-select">
                <option value="bubble">Bubble Sort</option>
                <option value="merge">Merge Sort</option>
                <option value="quick">Quick Sort</option>
            </select>
        </div>

        <div class="input-group">
            <label for="array-input">Input Array (comma-separated):</label>
            <input type="text" id="array-input" value="5,2,8,1,9,3,7,4,6" />
        </div>

        <div class="button-group">
            <button id="execute-btn" class="viz-btn viz-btn-primary">Execute</button>
            <button id="play-btn" class="viz-btn viz-btn-success" disabled>Play</button>
            <button id="pause-btn" class="viz-btn viz-btn-warning" disabled>Pause</button>
            <button id="step-btn" class="viz-btn viz-btn-info" disabled>Step</button>
            <button id="reset-btn" class="viz-btn viz-btn-danger" disabled>Reset</button>
        </div>

        <div class="input-group">
            <label for="speed-slider">Animation Speed:</label>
            <input type="range" id="speed-slider" min="1" max="10" value="5" />
            <span id="speed-label">Medium</span>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="visualization-canvas" width="1000" height="400"></canvas>
    </div>

    <div class="statistics">
        <h3>Statistics</h3>
        <p>Comparisons: <span id="comparisons">0</span></p>
        <p>Swaps: <span id="swaps">0</span></p>
        <p>Array Size: <span id="array-size">0</span></p>
        <p>Current Step: <span id="current-step">0</span> / <span id="total-steps">0</span></p>
        <p>Time Elapsed: <span id="time-elapsed">0</span> ms</p>
        <p>Status: <span id="status">Ready</span></p>
    </div>
</div>

<style>
    .viz-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .viz-container h1 {
        color: #333;
        margin-bottom: 30px;
        text-align: center;
    }

    .controls-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: bold;
    }

    .input-group select,
    .input-group input[type="text"] {
        width: 100%;
        max-width: 400px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
    }

    .input-group input[type="range"] {
        width: 300px;
        vertical-align: middle;
    }

    #speed-label {
        margin-left: 10px;
        color: #666;
        font-weight: bold;
    }

    .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
    }

    .viz-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
    }

    .viz-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .viz-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .viz-btn-primary { background: #007bff; }
    .viz-btn-success { background: #28a745; }
    .viz-btn-warning { background: #ffc107; color: #333; }
    .viz-btn-info { background: #17a2b8; }
    .viz-btn-danger { background: #dc3545; }

    .canvas-container {
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        display: flex;
        justify-content: center;
    }

    #visualization-canvas {
        max-width: 100%;
        height: auto;
        border: 1px solid #eee;
    }

    .statistics {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }

    .statistics h3 {
        margin-top: 0;
        color: #007bff;
    }

    .statistics p {
        margin: 8px 0;
        color: #555;
    }

    .statistics span {
        font-weight: bold;
        color: #333;
    }
</style>

<script>
    // Global variables
    let steps = [];
    let currentStep = 0;
    let isPlaying = false;
    let animationInterval = null;
    let startTime = 0;

    const canvas = document.getElementById('visualization-canvas');
    const ctx = canvas.getContext('2d');

    // Get CSRF token for Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Execute button click
    document.getElementById('execute-btn').addEventListener('click', async function() {
        const algorithm = document.getElementById('algorithm-select').value;
        const arrayInput = document.getElementById('array-input').value;

        document.getElementById('status').textContent = 'Loading...';

        try {
            const response = await fetch(`/algorithms/execute/${algorithm}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `array=${encodeURIComponent(arrayInput)}`
            });

            const data = await response.json();

            if (data.steps) {
                steps = data.steps;
                currentStep = 0;
                startTime = Date.now();

                document.getElementById('array-size').textContent = arrayInput.split(',').length;
                document.getElementById('total-steps').textContent = steps.length;
                document.getElementById('current-step').textContent = '0';
                document.getElementById('status').textContent = 'Ready to visualize';

                // Enable control buttons
                document.getElementById('play-btn').disabled = false;
                document.getElementById('step-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;

                // Draw initial state
                drawStep(steps[0]);
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('status').textContent = 'Error executing algorithm';
            alert('Error: ' + error.message);
        }
    });

    // Play button
    document.getElementById('play-btn').addEventListener('click', function() {
        if (!isPlaying && currentStep < steps.length) {
            isPlaying = true;
            document.getElementById('play-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('status').textContent = 'Playing...';

            const speed = parseInt(document.getElementById('speed-slider').value);
            const delay = 1100 - (speed * 100); // 1000ms (slow) to 100ms (fast)

            animationInterval = setInterval(() => {
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    drawStep(steps[currentStep]);
                    updateStatistics();
                } else {
                    // Animation complete
                    clearInterval(animationInterval);
                    isPlaying = false;
                    document.getElementById('play-btn').disabled = false;
                    document.getElementById('pause-btn').disabled = true;
                    document.getElementById('status').textContent = 'Complete!';
                }
            }, delay);
        }
    });

    // Pause button
    document.getElementById('pause-btn').addEventListener('click', function() {
        if (isPlaying) {
            clearInterval(animationInterval);
            isPlaying = false;
            document.getElementById('play-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('status').textContent = 'Paused';
        }
    });

    // Step button
    document.getElementById('step-btn').addEventListener('click', function() {
        if (currentStep < steps.length - 1) {
            currentStep++;
            drawStep(steps[currentStep]);
            updateStatistics();
            document.getElementById('status').textContent = `Step ${currentStep} of ${steps.length}`;
        }
    });

    // Reset button
    document.getElementById('reset-btn').addEventListener('click', function() {
        if (animationInterval) {
            clearInterval(animationInterval);
        }
        isPlaying = false;
        currentStep = 0;

        if (steps.length > 0) {
            drawStep(steps[0]);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        document.getElementById('comparisons').textContent = '0';
        document.getElementById('swaps').textContent = '0';
        document.getElementById('current-step').textContent = '0';
        document.getElementById('time-elapsed').textContent = '0';
        document.getElementById('status').textContent = 'Reset - Ready';

        document.getElementById('play-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
    });

    // Speed slider
    document.getElementById('speed-slider').addEventListener('input', function() {
        const speed = this.value;
        const labels = ['Slowest', 'Slower', 'Slow', 'Medium-', 'Medium', 'Medium+', 'Fast', 'Faster', 'Fastest', 'Lightning'];
        document.getElementById('speed-label').textContent = labels[speed - 1];
    });

    // Draw visualization on canvas
    function drawStep(step) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!step || !step.array) return;

        const arr = step.array;
        const n = arr.length;
        const barWidth = Math.min(60, canvas.width / n - 10);
        const maxVal = Math.max(...arr);

        for (let i = 0; i < n; i++) {
            const barHeight = (arr[i] / maxVal) * (canvas.height - 50);
            const x = i * (canvas.width / n) + (canvas.width / n - barWidth) / 2;
            const y = canvas.height - barHeight - 20;

            // Determine bar color
            let color = '#3498db'; // Default blue

            if (step.comparing && step.comparing.includes(i)) {
                color = '#e74c3c'; // Red for comparing
            } else if (step.swapped && step.swapped.includes(i)) {
                color = '#f39c12'; // Orange for swapped
            } else if (step.sorted_region && step.sorted_region.includes(i)) {
                color = '#2ecc71'; // Green for sorted
            }

            // Draw bar
            ctx.fillStyle = color;
            ctx.fillRect(x, y, barWidth, barHeight);

            // Draw value
            ctx.fillStyle = '#000';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(arr[i], x + barWidth / 2, canvas.height - 5);
        }

        // Draw message
        if (step.message) {
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(step.message, 10, 20);
        }
    }

    // Update statistics
    function updateStatistics() {
        if (currentStep >= 0 && currentStep < steps.length) {
            const step = steps[currentStep];

            if (step.comparisons !== undefined) {
                document.getElementById('comparisons').textContent = step.comparisons;
            }
            if (step.swaps !== undefined) {
                document.getElementById('swaps').textContent = step.swaps;
            }

            document.getElementById('current-step').textContent = currentStep;
            const elapsed = Date.now() - startTime;
            document.getElementById('time-elapsed').textContent = elapsed;
        }
    }
</script>
{% endblock %}
